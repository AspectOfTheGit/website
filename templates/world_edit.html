<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editing {{ title }}</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='icons/favicon.png') }}">
</head>

<body class="world">
    <nav class="navbar">
        <div class="logo">
            <a href="https://aspectofthe.site/" class="logo">
                <img src="{{ url_for('static', filename='icons/favicon.png') }}" alt="Logo" class="logo-img">
            </a>
            {{ title }}
        </div>
        <div class="nav-links">
            <a id="view-btn" class="nav-btn">View</a>
            <a id="settings-btn" class="nav-btn">Settings</a>
        </div>
        <div class="login">
            <a href="/account">{{ username }}</a>
        </div>
    </nav>

    <div class="editor-sidebar collapsed">
        <div class="editor-sidebar-handle">
            <span>Editor</span>
        </div>
        <div class="editor-sidebar-panel">
            <div class="editor-sidebar-content">
                <!-- Editor Elements -->
                <div class="editor-element" data-type="text" data-sidebar="true">
                    <span class="editor-element-title">Text</span>
                    <span class="editor-element-desc">Basic text</span>
                </div>
                <div class="editor-element" data-type="input" data-sidebar="true">
                    <span class="editor-element-title">Input</span>
                    <span class="editor-element-desc">User can type something</span>
                </div>
                <div class="editor-element" data-type="button" data-sidebar="true">
                    <span class="editor-element-title">Button</span>
                    <span class="editor-element-desc">Do something when pressed</span>
                </div>
                <div class="editor-element" data-type="color" data-sidebar="true">
                    <span class="editor-element-title">Color</span>
                    <span class="editor-element-desc">Solid color pixel</span>
                </div>
            </div>
        </div>
    </div>

    <div class="editor-menu-overlay hidden">
        <div class="editor-menu">
            <div class="editor-menu-tabs">
                <button class="editor-menu-tab active" data-tab="properties">Properties</button>
                <button class="editor-menu-tab" data-tab="extra">Extra</button>
                <button class="editor-menu-tab" data-tab="logic">Logic</button>
            </div>
    
            <div class="editor-menu-content">
                <div class="editor-menu-panel active" id="tab-element">
                    <h3>Element</h3>
                    <p>Core information of the element</p>
                </div>
                <div class="editor-menu-panel" id="tab-properties">
                    <h3>Properties</h3>
                    <p>Visuals of the element</p>
                </div>
                <div class="editor-menu-panel" id="tab-extra">
                    <h3>Extra</h3>
                    <p>Inputs for the elements properties/logic</p>
                </div>
                <div class="editor-menu-panel" id="tab-logic">
                    <h3>Logic</h3>
                    <p>Actions based on events</p>
                </div>
            </div>
        </div>
    </div>

    <div class="settings-menu-overlay hidden">
        <div class="settings-menu">
            <h2>World Page Settings</h2>
            <div class="settings-section">
                <label>
                    Page title
                    <input type="text" id="settings-title" value="{{ title }}">
                </label>
            </div>
            <div class="settings-section">
                <label>
                    Visibility
                    <select id="settings-visible">
                        <option value="true">Public</option>
                        <option value="false">Private</option>
                    </select>
                </label>
            </div>
            <div class="settings-actions">
                <button class="btn-secondary">Cancel</button>
                <button class="btn-primary">Save</button>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener("DOMContentLoaded", () => {
        const sidebar = document.querySelector(".editor-sidebar");
        const panel = document.querySelector(".editor-sidebar-panel");
        const handle = document.querySelector(".editor-sidebar-handle");
        const menuOverlay = document.querySelector(".editor-menu-overlay");
        const menuTabs = document.querySelectorAll(".editor-menu-tab");
        const menuPanels = document.querySelectorAll(".editor-menu-panel");
        const settingsOverlay = document.querySelector(".settings-menu-overlay");
        const settingsBtn = document.getElementById("settings-btn");
        
        let dragged = null;
        let offsetX = 0;
        let offsetY = 0;
        let holding = false;
        let dragging = false;
        let pressTimer = null;
        let startX = 0;
        let startY = 0;
        let didDrag = false;

        // Editor Elements
        
        document.addEventListener("pointerdown", e => {
            const el = e.target.closest(".editor-element");
            if (!el) return;
        
            startX = e.clientX;
            startY = e.clientY;
            didDrag = false;
        
            holding = true;
        
            if (el.dataset.sidebar === "true") {
                startDragFromSidebar(el, e);
                return;
            }
        
            pressTimer = setTimeout(() => {
                if (!holding) return;
                startDragExisting(el, e);
            }, 150);
        });
        
        document.addEventListener("pointermove", e => {
            if (!holding) return;
        
            const dx = Math.abs(e.clientX - startX);
            const dy = Math.abs(e.clientY - startY);
        
            if (!dragging && (dx > 6|| dy > 6)) {
                clearTimeout(pressTimer);
                holding = false;
                return;
            }
        
            if (!dragged) return;
        
            didDrag = true;
            moveDragged(e.clientX, e.clientY);
        
            const handleRect = handle.getBoundingClientRect();
            if (e.clientY > handleRect.top - 40) {
                sidebar.classList.add("expanded");
                sidebar.classList.remove("collapsed");
            } else {
                sidebar.classList.add("collapsed");
                sidebar.classList.remove("expanded");
            }
        });
        
        document.addEventListener("pointerup", e => {
            clearTimeout(pressTimer);
            holding = false;
        
            if (!didDrag) {
                const el = e.target.closest(".placed");
                if (el) openEditorMenu();
                dragged = null;
                return;
            }
        
            if (!dragged) return;
        
            const sidebarRect = sidebar.getBoundingClientRect();
        
            if (e.clientY > sidebarRect.top && e.clientY < sidebarRect.bottom) {
                dragged.remove();
            } else {
                dragged.classList.remove("dragging");
                dragged.classList.add("placed");
                dragged.style.position = "absolute";
                dragged.style.left = `${e.pageX - offsetX}px`;
                dragged.style.top = `${e.pageY - offsetY}px`;
                dragged.style.cursor = "default";
            }
        
            dragged = null;
            dragging = false;
            didDrag = false;
        
            sidebar.classList.add("collapsed");
            sidebar.classList.remove("expanded");
        });
        
        function moveDragged(x, y) {
            dragged.style.left = `${x - offsetX}px`;
            dragged.style.top = `${y - offsetY}px`;
        }

        function startDragFromSidebar(el, e) {
            dragged = el.cloneNode(true);
            dragged.classList.add("dragging");
            dragged.dataset.sidebar = "false";
            document.body.appendChild(dragged);
        
            dragging = true;
            didDrag = true;
        
            const rect = el.getBoundingClientRect();
            offsetX = e.clientX - rect.left;
            offsetY = e.clientY - rect.top;
        
            moveDragged(e.clientX, e.clientY);
            dragged.setPointerCapture(e.pointerId);
        }
        
        function startDragExisting(el, e) {
            dragged = el;
            dragged.classList.add("dragging");
            dragged.classList.remove("placed");

            dragged.style.cursor = "grabbing";
        
            dragging = true;
            didDrag = true;
        
            const rect = el.getBoundingClientRect();
            offsetX = e.clientX - rect.left;
            offsetY = e.clientY - rect.top;
        
            moveDragged(e.clientX, e.clientY);
            dragged.setPointerCapture(e.pointerId);
        }

        // Editor Sidebar

        handle.addEventListener("click", () => {
            sidebar.classList.toggle("expanded");
            sidebar.classList.toggle("collapsed");
        });
        
        document.querySelectorAll('.nav-btn').forEach(btn => {
            btn.addEventListener('click', async () => {
                if (btn.getAttribute("id") == "view-btn") {
                    // Save, wait for response and view page
                    window.location.href = "http://aspectofthe.site/world/{{ world_uuid }}";
                }
                if (btn.getAttribute("id") == "settings-btn") {
                    // Page settings
                }
            });
        });

        // Element Editor Menu
        
        function openEditorMenu() {
            menuOverlay.classList.remove("hidden");
        }
        
        function closeEditorMenu() {
            menuOverlay.classList.add("hidden");
        }
        
        menuOverlay.addEventListener("click", e => {
            if (e.target === menuOverlay) closeEditorMenu();
        });
        
        menuTabs.forEach(tab => {
            tab.addEventListener("click", () => {
                menuTabs.forEach(t => t.classList.remove("active"));
                menuPanels.forEach(p => p.classList.remove("active"));
        
                tab.classList.add("active");
                document
                    .getElementById("tab-" + tab.dataset.tab)
                    .classList.add("active");
            });
        });

        // Page Settings Menu

        let settings = {
            "title": "{{ title }}",
            "public": true
        };

        function openSettingsMenu() {
            document.getElementById("settings-title").value = settings.title;
            document.getElementById("settings-visible").value = settings.public ? "true" : "false";
            
            settingsOverlay.classList.remove("hidden");
        }

        function saveSettingsMenu() {
            settings.title = document.getElementById("settings-title").value.trim();
            settings.public = document.getElementById("settings-visible").value === "true";

            settingsOverlay.classList.add("hidden");
        }

        function cancelSettingsMenu() {
            settingsOverlay.classList.add("hidden");
        }
        
        settingsBtn.addEventListener("click", () => {
            openSettingsMenu();
        });
        
        settingsOverlay.addEventListener("click", e => {
            if (e.target === settingsOverlay) {
                cancelSettingsMenu();
            }
        });
        
        settingsOverlay.querySelector(".btn-secondary")
            .addEventListener("click", () => {
                cancelSettingsMenu();
            });

        settingsOverlay.querySelector(".btn-primary")
            .addEventListener("click", () => {
                saveSettingsMenu();
            });

        // Escape to close menus
        
        document.addEventListener("keydown", e => {
            if (e.key === "Escape") {
                closeEditorMenu();
                cancelSettingsMenu();
            }
        });
    });
    </script>
</body>
</html>
