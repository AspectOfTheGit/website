<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ bot_name }}</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='icons/favicon.png') }}">
</head>
<footer class="site-footer">
  <div class="footer-left">
    <a href="https://store.legitimoose.com" target="_blank" rel="noopener noreferrer">
        <img src="{{ url_for('static', filename='icons/cart.svg') }}" alt="Store" width="64" height="64">
    </a>
  </div>

  <div class="footer-center">
    <p>
      This is not an official Moose project and is made by the community.<br>
      We have no affiliation with any real-world brands.<br>
      Not affiliated with Mojang AB or Partners.
    </p>
  </div>

  <div class="footer-right">
    <a href="https://www.youtube.com/@Legitimoose" target="_blank" rel="noopener noreferrer">
        <img src="{{ url_for('static', filename='icons/youtube.svg') }}" alt="YouTube" width="64" height="64">
    </a>
  </div>
</footer>

<body>
    <nav class="navbar">
        <div class="logo">
            <a href="https://aspectofthe.site/" class="logo">
                <img src="{{ url_for('static', filename='icons/favicon.png') }}" alt="Logo" width="64" height="64">
            </a>
            Aspect Bots
        </div>
        <div class="nav-links">
            <a href="/bots">Home</a>
            <a href="/bots/status">Bot status</a>
            <a href="/bots/deploy">Deploy bot</a>
        </div>
        <div class="login">
            {% if username %}
                <a href="/account">{{ username }}</a>
            {% else %}
                <a href="/login">Log in</a>
            {% endif %}
        </div>
    </nav>

    <h2>Live Log for {{ bot_name }}</h2>
    {% if is_deployer %}
        <h3>You deployed this bot</h3>
    {% endif %}

<div class="tab-container">
    <div class="tabs">
        <button class="tab-button active" data-tab="log">Log</button>
        <button class="tab-button" data-tab="screenshot">Screenshot</button>
    </div>

    <div class="controls">
        {% if is_deployer %}<button title="Disconnect bot" id="disconnect-btn" class="disconnect-button">
            <img src="{{ url_for('static', filename='icons/disconnect.svg') }}" class="disconnect-icon" alt="Disconnect">
        </button>
        <button title="Switch server" id="switch-server-btn" class="switch-server-button">
            <img src="{{ url_for('static', filename='icons/switch.svg') }}" class="switch-icon" alt="Switch Server">
        </button>{% endif %}
        <button title="Screenshot" id="screenshot-btn" class="screenshot-button">
            <img src="{{ url_for('static', filename='icons/screenshot.svg') }}" class="camera-icon" alt="Screenshot">
        </button>
    </div>

    <div id="log" class="tab-content active">
        <div id="log-container"></div>
    </div>

    <div id="screenshot" class="tab-content">
        <div id="screenshot-output">No screenshot taken yet.</div>
    </div>

    {% if can_chat %}<p id="bot-chat">Insert a chat box here</p>{% endif %}
</div>

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js" crossorigin="anonymous"></script>
<script>
document.addEventListener("DOMContentLoaded", () => {
    const socket = io("https://aspectofthe.site", { transports: ["websocket"] });
    const logContainer = document.getElementById("log-container");
    const screenshotOutput = document.getElementById("screenshot-output");
    const botName = {{ bot_name|tojson }};

    const tabButtons = document.querySelectorAll('.tab-button');
    const tabContents = document.querySelectorAll('.tab-content');

    tabButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            tabButtons.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            const target = btn.dataset.tab;
            tabContents.forEach(c => c.classList.remove('active'));
            document.getElementById(target).classList.add('active');
        });
    });

    let retryCount = 1;
    let retryMessageSpan = null;

    socket.emit('join', botName );

    socket.on('disconnect', (reason) => {
        console.log('Disconnected from server. Reason:', reason);
        logContainer.innerHTML += `<span style="color:#FF5555">[INFO] Client disconnected. Attempting to reconnect to logs...</span><br>`;
        logContainer.scrollTop = logContainer.scrollHeight;
        socket.emit('join', botName );
    });

    socket.on('connect', () => {
        console.log('Connected to socket');
        logContainer.innerHTML += `<span style="color:#55FF55">[INFO] Client connected.</span><br>`;
        logContainer.scrollTop = logContainer.scrollHeight;
        retryCount = 1;
        retryMessageSpan = null;
    });
    
    socket.on('connect_error', (error) => {
        console.log('Connection error:', error);
    
        if (!retryMessageSpan) {
            retryMessageSpan = document.createElement('span');
            retryMessageSpan.style.color = '#FFAA00';
            logContainer.appendChild(retryMessageSpan);
            logContainer.appendChild(document.createElement('br'));
        }
    
        retryMessageSpan.textContent = `[INFO] Failed to connect to logs. Retrying...${retryCount > 1 ? ` [x${retryCount}]` : ''}`;
        logContainer.scrollTop = logContainer.scrollHeight;
    
        setTimeout(() => {
            retryCount++;
            socket.emit('join', botName);
        }, 8000);
    });

    socket.on("log", (contents) => {
        const prefix = contents[0];
        const msg = contents[1].replace(/<br\s*\/?>/gi, "\n");
        logContainer.innerHTML += `[${prefix}] ${msg}<br>`;
        logContainer.scrollTop = logContainer.scrollHeight;
    });

    logContainer.addEventListener("mouseover", e => {
        const span = e.target.closest("span[data-hover]");
        if (!span) return;
    
        let popup = span.querySelector(".hover-popup");
        if (!popup) {
            popup = document.createElement("div");
            popup.classList.add("hover-popup");
    
            try {
                const hoverData = JSON.parse(span.dataset.hover);
                function renderHover(data) {
                    if (data.components) {
                        return data.components.map(renderHover).join("");
                    }
                    let style = "";
                    if (data.style) {
                        if (data.style.color) style += `color:${data.style.color};`;
                        if (data.style.isBold) style += "font-weight:bold;";
                        if (data.style.isItalic) style += "font-style:italic;";
                        if (data.style.isUnderlined) style += "text-decoration:underline;";
                        if (data.style.isStrikethrough) style += "text-decoration:line-through;";
                    }
                    return `<span style="${style}">${data.text || ""}</span>`;
                }
    
                popup.innerHTML = renderHover(hoverData);
            } catch {
                popup.textContent = span.dataset.hover;
            }
    
            span.appendChild(popup);
        }
    
        span.classList.add("hovered");
    });
    
    logContainer.addEventListener("mouseout", e => {
        const span = e.target.closest("span[data-hover]");
        if (!span) return;
        span.classList.remove("hovered");
    });

    logContainer.addEventListener("click", e => {
        const span = e.target.closest("span[data-click]");
        if (!span) return;
    
        const clickData = JSON.parse(span.dataset.click);
        const overlay = document.createElement("div");
        overlay.classList.add("click-confirm");
    
        let html = `<p>Would you like to ${clickData.type === "OPEN_URL" ? "open this URL?" : "copy to clipboard?"}</p>`;
        html += `<pre>${clickData.command}</pre>`;
        html += `<button class="copy">Copy</button>`;
        if (clickData.type === "OPEN_URL") html += `<button class="open">Open URL</button>`;
        html += `<button class="cancel">Cancel</button>`;
        overlay.innerHTML = html;
        document.body.appendChild(overlay);
    
        overlay.style.display = "block";
    
        overlay.querySelector("button.copy")?.addEventListener("click", () => {
            navigator.clipboard.writeText(clickData.command);
            overlay.remove();
        });
        overlay.querySelector("button.open")?.addEventListener("click", () => {
            window.open(clickData.command, "_blank");
            overlay.remove();
        });
        overlay.querySelector("button.cancel").addEventListener("click", () => overlay.remove());
    });

    socket.on("screenshot", (data) => {
        const img = document.createElement("img");
        img.src = "data:image/png;base64," + data.image;
        img.alt = "Screenshot";
        img.style.maxWidth = "100%";
        img.style.maxHeight = "100%";
    
        screenshotOutput.innerHTML = "";
        screenshotOutput.appendChild(img);
    
        document.querySelector('[data-tab="screenshot"]').click();
    });

    document.getElementById("screenshot-btn").addEventListener("click", () => {
        socket.emit("get_screenshot", { bot: botName });
    });{% if is_deployer %}
    document.getElementById("disconnect-btn").addEventListener("click", () => {
        socket.emit("bot_disconnect", { bot: botName });
    });
    document.getElementById("switch-server-btn").addEventListener("click", () => {
        const worldUUID = prompt("World UUID");
        socket.emit("bot_switch_server", { bot: botName, world: worldUUID });
    });{% endif %}{% if can_chat %}
    document.getElementById("bot-chat").addEventListener("click", () => {
        socket.emit("bot_chat", { bot: botName, msg: prompt("Message") });
    });{% endif %}
});
</script>

