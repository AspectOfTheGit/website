<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aspect's Site</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='icons/favicon.png') }}">
</head>
<footer class="site-footer">
  <div class="footer-left">
    <a href="https://store.legitimoose.com" target="_blank" rel="noopener noreferrer">
        <img src="{{ url_for('static', filename='icons/cart.svg') }}" alt="Store" width="64" height="64">
    </a>
  </div>

  <div class="footer-center">
    <p>
      This is not an official Moose project and is made by the community.<br>
      We have no affiliation with any real-world brands.<br>
      Not affiliated with Mojang AB or Partners.
    </p>
  </div>

  <div class="footer-right">
    <a href="https://www.youtube.com/@Legitimoose" target="_blank" rel="noopener noreferrer">
        <img src="{{ url_for('static', filename='icons/youtube.svg') }}" alt="YouTube" width="64" height="64">
    </a>
  </div>
</footer>

<body>
    <nav class="navbar">
        <div class="logo">
            <a href="https://aspectofthe.site/" class="logo">
                <img src="{{ url_for('static', filename='icons/favicon.png') }}" alt="Logo" class="logo-img">
            </a>
            Aspect's Site
        </div>
    </nav>

    <h2>Voice Room</h2>
    <h3>{{ world_uuid }}</h3>
    <p>Audio is not stored anywhere. I don't have enough space to store it anyway.</p>
    <div id="voice-controls" style="margin: 10px 0;">
        <button id="mute-btn">Mute</button>
        <button id="deafen-btn">Deafen</button>
        <label for="mic-select">Mic:</label>
        <select id="mic-select"></select>
    </div>
    
    <div id="user-volumes" style="margin-top: 10px;">
        <h4>User Volumes</h4>
    </div>
</body>

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js" crossorigin="anonymous"></script>
<script>
document.addEventListener("DOMContentLoaded", async () => {
    const socket = io("https://aspectofthe.site", { transports: ["websocket"] });
    const room = "voice-{{ world_uuid }}";

    const peers = {};
    const audioElementsByUUID = {};
    const volumeControlsByUUID = {};
    let localStream;
    let myPos = [0,0,0];
    const MAX_DISTANCE = 10;

    let isMuted = false;
    let isDeafened = false;

    const muteBtn = document.getElementById("mute-btn");
    const deafenBtn = document.getElementById("deafen-btn");
    const micSelect = document.getElementById("mic-select");
    const userVolumesDiv = document.getElementById("user-volumes");

    async function populateMicrophones() {
        const devices = await navigator.mediaDevices.enumerateDevices();
        const mics = devices.filter(d => d.kind === "audioinput");
        micSelect.innerHTML = "";
        mics.forEach(d => {
            const opt = document.createElement("option");
            opt.value = d.deviceId;
            opt.textContent = d.label || `Mic ${micSelect.length+1}`;
            micSelect.appendChild(opt);
        });
    }

    async function getLocalStream(deviceId=null) {
        if(localStream){
            localStream.getTracks().forEach(t => t.stop());
        }
        localStream = await navigator.mediaDevices.getUserMedia({
            audio: deviceId ? { deviceId } : true
        });
        localStream.getAudioTracks().forEach(track => track.enabled = !isMuted);

        Object.values(peers).forEach(pc => {
            const sender = pc.getSenders().find(s => s.track && s.kind === "audio");
            if(sender) sender.replaceTrack(localStream.getAudioTracks()[0]);
        });
    }

    await populateMicrophones();
    await getLocalStream();

    micSelect.addEventListener("change", async () => {
        await getLocalStream(micSelect.value);
    });

    muteBtn.addEventListener("click", () => {
        isMuted = !isMuted;
        muteBtn.textContent = isMuted ? "Unmute" : "Mute";
        localStream.getAudioTracks().forEach(track => track.enabled = !isMuted);
    });

    deafenBtn.addEventListener("click", () => {
        isDeafened = !isDeafened;
        deafenBtn.textContent = isDeafened ? "Undeafen" : "Deafen";
        Object.values(audioElementsByUUID).forEach(el => el.muted = isDeafened);
    });

    socket.emit("join", room);

    socket.on("existing-peers", async (peerSids) => {
        for(const sid of peerSids) await createPeerConnection(sid, true);
    });
    socket.on("new-peer", async (peerSid) => {
        if(!peers[peerSid]) await createPeerConnection(peerSid, false);
    });
    socket.on("signal", async (data) => {
        const from = data.from;
        const signal = data.signal;

        if(!peers[from]) await createPeerConnection(from, false);
        const pc = peers[from];

        if(signal.type === "offer"){
            await pc.setRemoteDescription(signal);
            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);
            socket.emit("signal",{to:from, signal: pc.localDescription});
        }else if(signal.type==="answer"){
            await pc.setRemoteDescription(signal);
        }else if(signal.candidate){
            try{ await pc.addIceCandidate(signal.candidate);}catch(e){ console.warn(e);}
        }
    });

    async function createPeerConnection(peerSid,isInitiator){
        const pc = new RTCPeerConnection({ iceServers:[{urls:"stun:stun.l.google.com:19302"}] });
    
        peers[peerSid] = pc;
    
        localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
    
        pc.ontrack = (event) => {
            const audioEl = document.createElement("audio");
            audioEl.srcObject = event.streams[0];
            audioEl.autoplay = true;
            audioEl.controls = false;
            audioEl.muted = isDeafened;
            document.body.appendChild(audioEl);
    
            audioElementsByUUID[peerSid] = audioEl;
        };
    
        pc.onicecandidate = (event) => {
            if(event.candidate) socket.emit("signal",{to:peerSid,signal:{candidate:event.candidate}});
        };
    
        if(isInitiator){
            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);
            socket.emit("signal",{to:peerSid, signal: pc.localDescription});
        }
    }

    function parsePos(posStr){
        return posStr.replace(/\[|\]/g,"").split(",").map(s=>parseFloat(s.replace("d","")));
    }
    function distance3D(a,b){
        const dx=a[0]-b[0], dy=a[1]-b[1], dz=a[2]-b[2];
        return Math.sqrt(dx*dx + dy*dy + dz*dz);
    }

    function updateVolumes(players){
        players.forEach(player=>{
            if (!player.Pos || !Array.isArray(player.Pos)) return;
        
            if(player.uuid === "{{ mc_uuid }}"){
                myPos = player.Pos;
                return;
            }
        
            let audioEl = audioElementsByUUID[player.uuid] || audioElementsByUUID[Object.keys(peers).find(sid => sid === player.uuid)];
        
            if(!volumeControlsByUUID[player.uuid]){
                const container = document.createElement("div");
                container.style.display = "flex";
                container.style.alignItems = "center";
                container.style.gap = "8px";
                container.style.marginBottom = "6px";
        
                const head = document.createElement("img");
                head.src = `https://mc-heads.net/head/${player.uuid}/left`;
                head.width = 32;
                head.height = 32;
                head.style.borderRadius = "4px";
        
                const label = document.createElement("span");
                label.textContent = player.Name;
                label.style.minWidth = "260px";
                label.style.fontFamily = "monospace";
                label.style.fontSize = "12px";
        
                const slider = document.createElement("input");
                slider.type = "range";
                slider.min = 0;
                slider.max = 1;
                slider.step = 0.01;
                slider.value = 1;
                slider.style.flex = "1";
        
                slider.addEventListener("input", ()=>{
                    if(audioEl) audioEl.volume = parseFloat(slider.value) * (audioEl.volume || 1);
                });
        
                container.appendChild(head);
                container.appendChild(label);
                container.appendChild(slider);
        
                userVolumesDiv.appendChild(container);
                volumeControlsByUUID[player.uuid] = slider;
            }
        
            const dist = distance3D(myPos, player.Pos);
            const vol = Math.max(0, Math.min(1, 1 - dist / MAX_DISTANCE));
        
            if(audioEl) audioEl.volume = isDeafened ? 0 : vol * parseFloat(volumeControlsByUUID[player.uuid].value);
        });
    }

    socket.on("update", (players)=>{
        updateVolumes(players);
    });

});
</script>
